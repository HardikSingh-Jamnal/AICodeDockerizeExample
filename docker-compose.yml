version: "3.8"

services:
  # Backend Services
  purchase-api:
    build:
      context: ./backend
      dockerfile: ./Purchase/Dockerfile
    ports:
      - "5006:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Host=purchase-db;Database=purchase_db;Username=user;Password=password
      - ConnectionStrings__Redis=purchase-cache
      - MessageBroker__Host=rabbitmq
      - MessageBroker__Port=5672
      - MessageBroker__Username=admin
      - MessageBroker__Password=password
    depends_on:
      purchase-db:
        condition: service_healthy
      purchase-cache:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  transport-api:
    build:
      context: ./backend/Transport
      dockerfile: Dockerfile
    ports:
      - "5004:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Host=transport-db;Database=transport_db;Username=user;Password=password
      - ConnectionStrings__Redis=transport-cache
      - MessageBroker__Host=rabbitmq
      - MessageBroker__Port=5672
      - MessageBroker__Username=admin
      - MessageBroker__Password=password
    depends_on:
      transport-db:
        condition: service_healthy
      transport-cache:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  offers-api:
    build:
      context: ./backend
      dockerfile: ./Offers/Dockerfile
    ports:
      - "5005:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Host=offers-db;Database=offers_db;Username=user;Password=password
      - ConnectionStrings__Redis=offers-cache
      - MessageBroker__Host=rabbitmq
      - MessageBroker__Port=5672
      - MessageBroker__Username=admin
      - MessageBroker__Password=password
    depends_on:
      offers-db:
        condition: service_healthy
      offers-cache:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Databases
  purchase-db:
    image: postgres:13
    container_name: purchase-db
    ports:
      - "5435:5432"
    environment:
      - POSTGRES_DB=purchase_db
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
    volumes:
      - purchase-db-data:/var/lib/postgresql/data
    networks:
      - backend-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d purchase_db"]
      interval: 30s
      timeout: 10s
      retries: 3

  offers-db:
    image: postgres:13
    container_name: offers-db
    ports:
      - "5436:5432"
    environment:
      - POSTGRES_DB=offers_db
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
    volumes:
      - offers-db-data:/var/lib/postgresql/data
    networks:
      - backend-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d offers_db"]
      interval: 30s
      timeout: 10s
      retries: 3

  transport-db:
    image: postgres:13
    container_name: transport-db
    ports:
      - "5437:5432"
    environment:
      - POSTGRES_DB=transport_db
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
    volumes:
      - transport-db-data:/var/lib/postgresql/data
    networks:
      - backend-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d transport_db"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Caches
  purchase-cache:
    image: redis:6.2
    ports:
      - "6384:6379"
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  transport-cache:
    image: redis:6.2
    ports:
      - "6382:6379"
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  offers-cache:
    image: redis:6.2
    ports:
      - "6383:6379"
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Message Broker
  rabbitmq:
    image: rabbitmq:3-management
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=password
    ports:
      - "5672:5672" # AMQP protocol
      - "15672:15672" # Management UI
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Elasticsearch for Search Service
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    networks:
      - backend-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Search Service
  search-api:
    build:
      context: ./backend
      dockerfile: ./Search/Dockerfile
    ports:
      - "5007:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - Elasticsearch__Uri=http://elasticsearch:9200
      - Elasticsearch__IndexName=search_entities
      - MessageBroker__Host=rabbitmq
      - MessageBroker__Port=5672
      - MessageBroker__Username=admin
      - MessageBroker__Password=password
    depends_on:
      elasticsearch:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  purchase-db-data:
  offers-db-data:
  transport-db-data:
  elasticsearch-data:

networks:
  backend-network:
    driver: bridge
